const u=["soList","activeSo","translateList","activeTranslate","linkSpan","copyClose","pwKey","defaultOpenAdd","soStyleIsRound","soAOpen","defauiltLink","isSoBarDown","linkOpenSelf","customkey","systemTheme","showHomeClock","homeLinkMaxNum","rollingBack","soHdCenter","tabTitle","webDavURL","webDavUsername","webDavPassword","webDavDir","homeImgOpacity"];let l={},s={},r=0,m=0;const d=(e,n)=>{m=Date.now();const t={};for(const o in n)Object.hasOwnProperty.call(n,o)&&u.includes(o)&&(t[o]=n[o]);s={...s,...t},setTimeout(()=>{if(!(m>Date.now())&&Object.keys(s).length>0){const o={...s};s={},chrome.storage.sync.set(o,function(a){r=0})}},1e3),e("seccusss")},g=()=>new Promise((e,n)=>{r+10*60*1e3>Date.now()?e(l):chrome.storage.sync.get(u,function(t){l=t,r=Date.now(),e(t)})}),h=(e,n)=>{g().then(t=>{e(t)})};chrome.runtime.onMessage.addListener(function(e,n,t){switch(e.type){case"setOptions":d(t,e.data);break;case"getOption":h(t);break}return!0});const c=(e,n,t)=>{const o={pageUrl:n.pageUrl,title:t.title,type:e,tabId:t.id};e==="text"?o.text=n.selectionText:o.imgUrl=n.srcUrl,chrome.storage.local.get(["contextMenusData"],function(a){let i=[];a?.contextMenusData?.length>0?i=[...a.contextMenusData,o]:i=[o],chrome.storage.local.set({contextMenusData:i})})};chrome.runtime.onInstalled.addListener(function(){chrome.contextMenus.create({id:"imageMenu",title:"将图片存储至便签",contexts:["image"]}),chrome.contextMenus.create({id:"textMenu",title:"将选中文本存储至便签",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener(function(e,n){e.menuItemId==="imageMenu"?c("image",e,n):e.menuItemId==="textMenu"&&chrome.tabs.sendMessage(n.id,{type:"onTextMenuCS"},function(t){chrome.runtime.lastError||!t?.html?c("text",e,n):c("text",{...e,selectionText:t.html},n)})});
